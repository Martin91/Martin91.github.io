
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Martin</title>
	<meta name="author" content="Martin">

	
	<meta name="description" content="问题背景 去年圣诞节当天，突然收到一个我经手过的项目的告警邮件，错误消息显示“Redis::CommandError: ERR max number of clients reached”。 什么情况？难道这个项目翻车了？第一反应是这台服务器运行着自建的 Redis 数据库， &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Martin" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="/javascripts/jquery-1.11.1.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">Martin</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:Martin91.github.io">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:Martin91.github.io">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner">


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/articles/2018/02/10/ji-yi-ci-redisshu-ju-ku-pei-zhi-dao-zhi-de-lian-jie-shu-xie-lou-de-wen-ti/">
		
			记一次Redis数据库配置导致的连接数泄露的问题</a>
	</h2>
	<div class="entry-content">
		<h3>问题背景</h3>

<p>去年圣诞节当天，突然收到一个我经手过的项目的告警邮件，错误消息显示<strong>“Redis::CommandError: ERR max number of clients reached”</strong>。
<img src="/images/posts/20180210/redis%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%B3%84%E9%9C%B2%E9%97%AE%E9%A2%98.002.jpeg" alt="Redis 连接数告警" /></p>

<p>什么情况？难道这个项目翻车了？第一反应是这台服务器运行着自建的 Redis 数据库，但是客户端只有同个内网的一个 Ruby on Rails 的应用，怎么会有连接数爆掉的可能？</p>


		
		<a href="/blog/articles/2018/02/10/ji-yi-ci-redisshu-ju-ku-pei-zhi-dao-zhi-de-lian-jie-shu-xie-lou-de-wen-ti/" class="more-link">Read on &rarr;</a>
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2018-02-10T20:35:39+08:00" pubdate data-updated="true">Feb 10<span>th</span>, 2018</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/redis/'>Redis</a>, <a class='category' href='/blog/categories/shu-ju-ku/'>数据库</a>, <a class='category' href='/blog/categories/zui-da-lian-jie-shu/'>最大连接数</a>, <a class='category' href='/blog/categories/mo-ren-pei-zhi-wen-ti/'>默认配置问题</a>


</div>
	
	<div class="comments"><a href="/blog/articles/2018/02/10/ji-yi-ci-redisshu-ju-ku-pei-zhi-dao-zhi-de-lian-jie-shu-xie-lou-de-wen-ti/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/articles/2017/10/14/jie-du-rails-migrations/">
		
			解读 Rails: Migrations</a>
	</h2>
	<div class="entry-content">
		<p>此文翻译自<a href="http://www.monkeyandcrow.com/blog/reading_rails_migrations/">Reading Rails &ndash; Migrations</a>，限于本人水平，翻译不当之处，敬请指教！</p>

<p>今天我们将会探讨一下 Rails 经常被忽视的可靠的工作伙伴 —— Migrator。它是如何搜寻你的 migrations 并且执行它们的呢？我们将再一次慢慢地挖掘 Rails 的源代码，并在此过程中慧海拾珠。</p>


		
		<a href="/blog/articles/2017/10/14/jie-du-rails-migrations/" class="more-link">Read on &rarr;</a>
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2017-10-14T22:29:20+08:00" pubdate data-updated="true">Oct 14<span>th</span>, 2017</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/rails-migrations/'>Rails Migrations</a>, <a class='category' href='/blog/categories/fan-yi/'>翻译</a>, <a class='category' href='/blog/categories/jie-du-rails/'>解读Rails</a>


</div>
	
	<div class="comments"><a href="/blog/articles/2017/10/14/jie-du-rails-migrations/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/articles/2017/02/18/dong-tai-mi-ma-suan-fa-jie-shao-yu-shi-xian/">
		
			动态密码算法介绍与实现</a>
	</h2>
	<div class="entry-content">
		<p>动态密码，亦称一次性密码（One Time Password, 简称 OTP），是一种高效简单又比较安全的密码生成算法，在我们的生活以及工作中随处可见，身为开发者，也或多或少在自己的业务系统中集成了二步验证机制，那么，技术运用，既要知其然，更要知其所以然，动态密码算法是怎样的？</p>


		
		<a href="/blog/articles/2017/02/18/dong-tai-mi-ma-suan-fa-jie-shao-yu-shi-xian/" class="more-link">Read on &rarr;</a>
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2017-02-18T09:54:22+08:00" pubdate data-updated="true">Feb 18<span>th</span>, 2017</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/authenticator/'>Authenticator</a>, <a class='category' href='/blog/categories/dong-tai-mi-ma/'>动态密码</a>, <a class='category' href='/blog/categories/suan-fa/'>算法</a>


</div>
	
	<div class="comments"><a href="/blog/articles/2017/02/18/dong-tai-mi-ma-suan-fa-jie-shao-yu-shi-xian/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/articles/2016/11/26/zhou-mo-dao-le-lai-duan-dai-ma-ya-ya-jing/">
		
			周末到了，来段代码压压惊</a>
	</h2>
	<div class="entry-content">
		<p>最近一段时间，写了两篇关于 sidekiq 的源码分析，但是一直想要补充的一段 sidekiq 里边的代码其实是挺有趣也挺逗的，所以这个星期就不要长篇大论的源码分析，来点轻松点的吧。</p>


		
		<a href="/blog/articles/2016/11/26/zhou-mo-dao-le-lai-duan-dai-ma-ya-ya-jing/" class="more-link">Read on &rarr;</a>
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2016-11-26T21:43:30+08:00" pubdate data-updated="true">Nov 26<span>th</span>, 2016</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/cheng-xu-yuan/'>程序猿</a>, <a class='category' href='/blog/categories/xiao-dian/'>笑点</a>, <a class='category' href='/blog/categories/qu-wei/'>趣味</a>


</div>
	
	<div class="comments"><a href="/blog/articles/2016/11/26/zhou-mo-dao-le-lai-duan-dai-ma-ya-ya-jing/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/articles/2016/11/20/sidekiq-xin-hao-chu-li-yuan-ma-fen-xi/">
		
			Sidekiq 信号处理源码分析</a>
	</h2>
	<div class="entry-content">
		<h3>引言</h3>

<p>在之前的文章<a href="/blog/articles/2016/10/29/sidekiqren-wu-diao-du-liu-cheng-fen-xi/">《Sidekiq任务调度流程分析》</a>中，我们一起仔细分析了 Sidekiq 是如何基于多线程完成队列任务处理以及调度的。我们在之前的分析里，看到了不管是 <code>Sidekiq::Scheduled::Poller</code> 还是 <code>Sidekiq::Processor</code> 的核心代码里，都会有一个由 <code>@done</code> 实例变量控制的循环体：</p>


		
		<a href="/blog/articles/2016/11/20/sidekiq-xin-hao-chu-li-yuan-ma-fen-xi/" class="more-link">Read on &rarr;</a>
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2016-11-20T10:08:07+08:00" pubdate data-updated="true">Nov 20<span>th</span>, 2016</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/sidekiq/'>sidekiq</a>, <a class='category' href='/blog/categories/xin-hao-chu-li/'>信号处理</a>, <a class='category' href='/blog/categories/xian-cheng-guan-li/'>线程管理</a>


</div>
	
	<div class="comments"><a href="/blog/articles/2016/11/20/sidekiq-xin-hao-chu-li-yuan-ma-fen-xi/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/articles/2016/10/29/sidekiqren-wu-diao-du-liu-cheng-fen-xi/">
		
			Sidekiq任务调度流程分析</a>
	</h2>
	<div class="entry-content">
		<p><a href="http://sidekiq.org/">sidekiq</a>是 Ruby 中一个非常优秀而且可靠的后台任务处理软件，其依赖 Redis 实现队列任务的增加、重试以及调度等。而 sidekiq 从启动到开始不断处理任务、定时任务以及失败任务的重试，都是如何调度的呢？遇到问题的时候，又该如何调优呢？</p>


		
		<a href="/blog/articles/2016/10/29/sidekiqren-wu-diao-du-liu-cheng-fen-xi/" class="more-link">Read on &rarr;</a>
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2016-10-29T16:32:28+08:00" pubdate data-updated="true">Oct 29<span>th</span>, 2016</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/sidekiq/'>sidekiq</a>, <a class='category' href='/blog/categories/ren-wu-diao-du/'>任务调度</a>, <a class='category' href='/blog/categories/hou-tai-ren-wu/'>后台任务</a>


</div>
	
	<div class="comments"><a href="/blog/articles/2016/10/29/sidekiqren-wu-diao-du-liu-cheng-fen-xi/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/articles/2016/01/17/pay-attention-to-your-double-equals/">
		
			嘿，小心你的双等号==</a>
	</h2>
	<div class="entry-content">
		<p>前两天在写代码的时候，突然收到警告说项目代码中存在 XSS 漏洞，遂立即根据报告的 URL 排查页面代码，虽然很快就修复了，而且同样问题的讨论两年前就有了，看<a href="https://ruby-china.org/topics/16633">RubyChina: 别用 raw 和 html_safe</a>，一般来说相对有经验的老鸟也应该都知道这个点，但是还是觉得有必要写出来，再次提醒一下其他小伙伴，避免踩坑。</p>


		
		<a href="/blog/articles/2016/01/17/pay-attention-to-your-double-equals/" class="more-link">Read on &rarr;</a>
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2016-01-17T01:40:48+08:00" pubdate data-updated="true">Jan 17<span>th</span>, 2016</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/keng/'>坑</a>, <a class='category' href='/blog/categories/mo-ban/'>模板</a>, <a class='category' href='/blog/categories/xian-jing/'>陷阱</a>


</div>
	
	<div class="comments"><a href="/blog/articles/2016/01/17/pay-attention-to-your-double-equals/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/articles/2015/10/30/jin-fang-activesupport-cache-store-huan-cun-nil-zhi/">
		
			谨防 ActiveSupport::Cache::Store 缓存 Nil 值</a>
	</h2>
	<div class="entry-content">
		<p>Rails 中的 <strong><a href="https://github.com/rails/rails/tree/master/activesupport">active_support</a></strong> 组件主要基于 Rails 需要提供了很多非常有用的基础工具以及对 Ruby 内置类进行扩展。其中的 cache 模块主要提供了 Rails 中底层缓存的定义以及简单实现。今天要跟大家探讨的是之前在使用此模块所遇到的一个坑，有兴趣学习其基本用法的可以点击以下两个链接：</p>

<ul>
<li><a href="http://guides.rubyonrails.org/caching_with_rails.html#activesupport-cache-store">Rails Guides: ActiveSupport::Cache::Store</a></li>
<li><a href="http://api.rubyonrails.org/classes/ActiveSupport/Cache/Store.html">Rails API: ActiveSupport::Cache::Store</a></li>
</ul>



		
		<a href="/blog/articles/2015/10/30/jin-fang-activesupport-cache-store-huan-cun-nil-zhi/" class="more-link">Read on &rarr;</a>
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-10-30T20:48:41+08:00" pubdate data-updated="true">Oct 30<span>th</span>, 2015</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/active-support/'>active_support</a>, <a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/tricks/'>tricks</a>, <a class='category' href='/blog/categories/keng/'>坑</a>, <a class='category' href='/blog/categories/xian-jing/'>陷阱</a>


</div>
	
	<div class="comments"><a href="/blog/articles/2015/10/30/jin-fang-activesupport-cache-store-huan-cun-nil-zhi/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/articles/2015/10/21/use-chinese-pinyin-and-friendly-id-to-generate-slugs/">
		
			使用 Chinese_pinyin + Friendly_id 为中文标题生成 Slug</a>
	</h2>
	<div class="entry-content">
		<p>在许多项目中，我们可能都会遇到需要为数据生成 slug 的场景，这些场景类似于：</p>

<ul>
<li>基于商品名称生成 slug</li>
<li>基于文章标题生成 slug</li>
</ul>


<p>至于为什么需要生成 slug，而不是使用比如 Rails 中默认自增的主键也就是数据的 id，原因其实很简单：</p>

<ul>
<li>使用自增 id 容易暴露数据，比如通过订单 id 可能导致遍历所有订单，不信，你看这里就有个<a href="http://www.wooyun.org/bugs/wooyun-2015-0127301">例子</a></li>
<li>增加 URL 友好性，/products/18376 这样的链接肯定没有比 /products/apple-watch-gold 这样的链接更招人喜欢</li>
</ul>



		
		<a href="/blog/articles/2015/10/21/use-chinese-pinyin-and-friendly-id-to-generate-slugs/" class="more-link">Read on &rarr;</a>
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-10-21T22:20:07+08:00" pubdate data-updated="true">Oct 21<span>st</span>, 2015</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/slug-generation-friendly/'>slug generation friendly</a>


</div>
	
	<div class="comments"><a href="/blog/articles/2015/10/21/use-chinese-pinyin-and-friendly-id-to-generate-slugs/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/articles/2015/09/13/mysql-in-query-and-order-by-field-function/">
		
			MySQL in 查询，并通过 FIELD 函数按照查询条件顺序返回结果</a>
	</h2>
	<div class="entry-content">
		<p>我们都非常习惯通过 MySQL 的 <a href="https://dev.mysql.com/doc/refman/5.0/en/comparison-operators.html#function_in">IN 函数</a>来查询特定集合的数据，比如为了在 books 表中找出李雷、韩梅梅和安华写的书，我们可以有如下的 SQL（可以通过 <a href="http://sqlfiddle.com/#!9/1982d">SQL Fiddle</a>查看示例）：</p>


		
		<a href="/blog/articles/2015/09/13/mysql-in-query-and-order-by-field-function/" class="more-link">Read on &rarr;</a>
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-09-13T20:24:07+08:00" pubdate data-updated="true">Sep 13<span>th</span>, 2015</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/mysql-database-order-query/'>MySQL Database order Query</a>


</div>
	
	<div class="comments"><a href="/blog/articles/2015/09/13/mysql-in-query-and-order-by-field-function/#disqus_thread">Comments</a></div>
	
</div>
</article>

<nav id="pagenavi">
    
    
        <a href="/blog/page/2/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
	<footer id="footer" class="inner">Copyright &copy; 2018

    Martin

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'martin-blog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//go.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-50624776-1']);
		_gaq.push(['_setDomainName','github.io']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F6d4498d8e2d7328fffdb1539f0589a61' type='text/javascript'%3E%3C/script%3E"));
</script>
<script>
  window.fbAsyncInit = function() {
    FB.init({
      appId      : '781315158664022',
      xfbml      : true,
      version    : 'v2.4'
    });
  };

  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "//connect.facebook.net/en_US/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));
</script>

</body>
</html>