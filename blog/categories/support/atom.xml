<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: support | Martin]]></title>
  <link href="http://Martin91.github.io/blog/categories/support/atom.xml" rel="self"/>
  <link href="http://Martin91.github.io/"/>
  <updated>2016-11-20T13:22:50+08:00</updated>
  <id>http://Martin91.github.io/</id>
  <author>
    <name><![CDATA[Martin]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Split logs automatically every day]]></title>
    <link href="http://Martin91.github.io/blog/articles/2013/09/07/split-logs-automatically-every-day/"/>
    <updated>2013-09-07T01:11:00+08:00</updated>
    <id>http://Martin91.github.io/blog/articles/2013/09/07/split-logs-automatically-every-day</id>
    <content type="html"><![CDATA[<p><strong>Related resource(s):</strong></p>

<p>&ldquo;linuxcommand: logrotate&rdquo;:<a href="http://linuxcommand.org/man_pages/logrotate8.html">http://linuxcommand.org/man_pages/logrotate8.html</a><br>
<strong>logrotate</strong>  is  designed to ease administration of systems that generate large numbers of log files. Normally, logrotate is run as a daily cron job.</p>

<p><strong>Some important knowledges:</strong></p>

<ul>
<li>Any number of config files may be given. Later config files may override the options given in earlier files, so the order in  which  the logrotate config files are listed in is important.  Normally, <strong>a single config file which includes any other config files which are  needed  should  be used</strong>.  If a directory is  given, every file in that directory is used as a config file.</li>
<li><strong>Default config file:</strong> /etc/logrotate.conf. You can include other config files within it using <strong>include</strong> directive.</li>
</ul>


<!-- More -->


<h2>Assumption</h2>

<ol>
<li>Your site is <code>example.com</code></li>
<li>The site is located in <code>/var/www/example/</code></li>
<li>Your site is deployed by Capistrano, so you can find your logs in <code>/var/www/example/shared/log/</code></li>
<li>Your static contents server is <strong>Nginx</strong>, and its logs are located in <code>/var/www/example/shared/log/</code> and their names start with <code>nginx_</code></li>
</ol>


<h2>How to do</h2>

<h3>1. Login your server</h3>

<h3>2. Make sure that &ldquo;include /etc/logrotate.d&rdquo; is existed in default config file and not commented:</h3>

<pre>
$ cat /etc/logrotate.conf
</pre>


<p>You should be able to find the directive shown below, if not, append it manully.</p>

<pre>
include /etc/logrotate.d
</pre>


<h3>3.Create new logrotate config files for your site&rsquo;s logs</h3>

<p><strong>A. Create new rotate config file for application log:</strong></p>

<pre>
$ sudo vim /etc/logrotate.d/example_production_log
</pre>


<p>Type following contents, and save.</p>

<pre>
/var/www/example/shared/log/production.log {

  daily

  missingok

  rotate 30

  notifempty

  create 664 deploy deploy

  copytruncate

}
</pre>


<p><strong>B. Create new rotate config file for server log:</strong></p>

<pre>
$ sudo vim /etc/logrotate.d/nginx-log-for-example
</pre>


<p>Type following contents, and save.</p>

<pre>
/var/www/example/shared/log/nginx_*.log {

  daily

  missingok

  rotate 30

  notifempty

  create 664 root root

  sharedscripts

  postrotate

  [ ! -f /var/run/nginx.pid ] || kill -USR1 `cat /var/run/nginx.pid`

  endscript
}
</pre>


<p><strong>Attention:</strong><br>
<strong>/var/run/nginx.pid</strong> is your nginx pid file path, but someone may use default nginx pid path(<strong>/opt/nginx/logs/nginx.pid</strong>). You have two solutions to solve this conflict:</p>

<blockquote><ol type="a">
<li>Change <code>/var/run/nginx.pid</code> to <code>/opt/nginx/logs/nginx.pid</code> or other path you have defined in your nginx config file.</li>
<li>Set your <strong>&ldquo;pid&rdquo;</strong> directive to expected path:
<pre>
pid /var/run/nginx.pid;
</pre>
in your nginx config file(such as, /opt/nginx/conf/nginx.conf), and then restart your server.</li>
</ol>
</blockquote>

<p>If the above work are all finished, everything done! You should remember to check if everything runs normally at other days.</p>
]]></content>
  </entry>
  
</feed>
